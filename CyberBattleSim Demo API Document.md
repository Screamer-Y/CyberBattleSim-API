# CyberBattleSim Demo API Document



### New Episode

Create an new episode simulator and return episode id. Will only return episode id and do not create new episode if episode already exists.

```
GET /demo/episodes/new/ HTTP/1.1
```

**Example response:**

```
"root": {
    "episode_id": "9d45d3e218c8ddfd00d8193ca90c0320"
    "info": "New episode inits."
}
```

Where episode_id is a unique identifier for the episode simulator.



### Reset Episode

Reset episode by 'episode_id ' if exists.

```
PUT /demo/episodes/{{episode_id}}/ HTTP/1.1
```

Where episode_id is the id of the episode.

**Example response:**

```
successfully reset.
STATUS CODE: 200
```



### Delete Episode

Delete episode by 'episode_id ' if exists.

```
DELETE /demo/episodes/{{episode_id}}/ HTTP/1.1
```

Where episode_id is the id of the episode.

**Example response:**

```
STATUS CODE: 204
```

Where episode_id is a unique identifier for the episode simulator.



### Get Env Figure

Returns an html which is generated by a plotly figure.

```
GET /demo/episodes/{{episode_id}}/fig/ HTTP/1.1
```

Where episode_id is the id of the episode.

**Example response:**

![image-20221123184553994](https://github.com/Screamer-Y/CyberBattleSim-API/blob/main/img1.png)



### List Nodes

Query node info by node id.

**Example request:**

```
GET /demo/episodes/{{episode_id}}/nodes/?node_id=Sharepoint HTTP/1.1
```

Where node_id is the id of the node.

The response is a Node object.

**Example response:**

```
"root": {
    "firewall": {
        "incoming": "[FirewallRule(port='SSH', permission=<RulePermission.ALLOW: 0>, reason=''), FirewallRule(port='HTTP', permission=<RulePermission.ALLOW: 0>, reason=''), FirewallRule(port='HTTPS', permission=<RulePermission.ALLOW: 0>, reason='')]"
        "outgoing": "[]"
    }
    "is_infected": false
    "owned_string": ""
    "privilege_level": 0
    "properties": [
        0:"SharepointLeakingPassword"
    ]
    "services": [
        0:"ListeningService(name='HTTPS', allowedCredentials=[], running=True)"
    ]
    "value": 100
    "vulnerabilities": {
        "ScanSharepointParentDirectory": {
            "cost": 1
            "description": "Navigate to SharePoint site, browse parent directory"
            "outcome": "LeakedCredentials"
            "reward_string": "Navigating to the Sharepoint site revealed AD Service Principal Credentials"
            "type": "VulnerabilityType.REMOTE"
        }
    }
}
```

Where a Node object is:

| Field           | Type      | Description                                                  |
| --------------- | --------- | ------------------------------------------------------------ |
| firewall        | Dict      | Firewall rules, including incoming rules and outgoing rules. |
| is_infected     | Bool      | True if a success connect attack run on the node.            |
| owned_string    | String    | Information attacker get after running a success connect attack on the node. |
| privilege_level | Int       | 0 refers to 'NoAccess' and 1 refers to 'LocalUser'.          |
| properties      | List[str] | Properties of the node.                                      |
| services        | String    | Services of the node, containing information of possible connect attack. |
| value           | Int       | Value of the node.                                           |
| vulnerabilities | Dict      | Vulnerabilities of the node.                                 |

A vulnerability contains:

| Field         | Description                                                  |
| ------------- | ------------------------------------------------------------ |
| name          | name of the vulnerability.                                   |
| description   | description of the vulnerability.                            |
| type          | type of the vulnerability. (local/remote)                    |
| outcome       | outcome of the vulnerability. (LeakedNodesId, LeakedCredentials...) |
| cost          | cost of the vulnerability.                                   |
| reward_string | The reward attacker get after running a success attack on the vulnerability. |

**If not specify node id, will return all node id:**

```
GET /demo/episodes/{{episode_id}}/nodes/ HTTP/1.1
```

**Example response:**

```
"root": {
    "nodes_id": "['Website', 'Website.Directory', 'Website[user=monitor]', 'GitHubProject', 'AzureStorage', 'Sharepoint', 'AzureResourceManager', 'AzureResourceManager[user=monitor]', 'AzureVM', 'client']"
}
```



### List Attacks

Query valid attacks in the current iteration by source node, target node and action type.

**Example request:**

```
GET /demo/episodes/{{episode_id}}/attacks/?source_node_id=client&target_node_id=Website&action_type=remote HTTP/1.1
```

With the following fields:

| Parameter      | Type   | Required? | Description                                                  |
| -------------- | ------ | --------- | ------------------------------------------------------------ |
| source_node_id | String | optional  | Query actions by specific source node. You can get node id using 'List Nodes' API. |
| target_node_id | String | optional  | Query actions by specific target node. You can get node id using 'List Nodes' API. |
| action_type    | String | optional  | Query actions by specific action type.('local'/'remote'/'connect') |

The response is a list of Action objects.

**Example response:**

```
"root": [
    0:{
        "remote_vulnerability": {
            "Q-value": 0.05826392024755478
            "remote_vulnerability": "ScanPageSource"
            "source_node_id": "client"
            "target_node_id": "Website"
        }
    }
    1: {
        "remote_vulnerability": {
            "Q-value": 0.03239026665687561
            "remote_vulnerability": "ScanPageContent"
            "source_node_id": "client"
            "target_node_id": "Website"
        }
    }
]
```

Where an Action object is:

| Field                | Type   | Description                                                  |
| -------------------- | ------ | ------------------------------------------------------------ |
| action_type          | String | The type of the attack. (local_vulnerability/remote_vulnerability/connect) |
| source_node_id       | String | Source node of the attack. (local_vulnerability/remote_vulnerability/connect) |
| target_node_id       | String | Target node of the attack. (remote_vulnerability/connect)    |
| local_vulnerability  | String | Vulnerability used in a local attack.                        |
| remote_vulnerability | String | Vulnerability used in a remote attack.                       |
| port                 | String | Port used in a connect attack.                               |
| credential           | String | Credential used in a connect attack.                         |
| Q-value              | Float  | Expected Q value of the action from the agent.               |



### Run Attack

Run attack in the simulation environment. You can run single step by specify the attack or let agent decide the attack. You can also let the agent run multi-steps of attacks.

1. **Example request:**

```
GET /demo/episodes/{{episode_id}}/run/
```

With the request which is an Action object:

```
{"action": {
    "local_vulnerability": {
        "local_vulnerability": "SearchEdgeHistory",
        "source_node_id": "client"
    }
}}
```

The response shows the outcome of the attack.

**Example response:**

```
{"iteration": 1, 
 "attack": "local_vulnerability(`client, SearchEdgeHistory)", 
 "outcome": "LeakedNodesId",
 "reward": 11.0, 
 "reward_info": "Web browser history revealed website URL of interest", 
 "manual": "manual"}
```

2. You can let the agent decide the attack by not specify the attack:

```
GET /demo/episodes/{{episode_id}}/run/
```

**And get response like:**

```
{"iteration":2,
 "attack":"remote_vulnerability(`client, `client, CredScanGitHistory)",
 "outcome":null,
 "reward":0.0,
 "reward_info":null,
 "manual":"agent"}
```

The outcome object is:

| Field       | Type   | Description                                           |
| ----------- | ------ | ----------------------------------------------------- |
| iteration   | Int    | Iteration count.                                      |
| attack      | String | Information of the attack.                            |
| outcome     | String | Outcome of the attack.                                |
| reward      | String | Reward of the attack.                                 |
| reward_info | String | Reward information of the attack.                     |
| manual      | String | A flag show whether human or agent select the attack. |

3. You can run multi-steps of attack by specify 'iteration_count' parameter:

```
GET /demo/episodes/510c0e10e02373cc95881040a33c6d21/run/?iteration_count=2 HTTP/1.1
```

**When 'iteration_count' is specified, you can only let agent selects the ations.** 

Response is generated by the 'pandas.DataFrame.to_json' function:

```
{"iteration": {"2": 3, "3": 4}, 
"attack": {"2": "remote_vulnerability(`client, `Website, ScanSharepointParentDirectory)", "3": "remote_vulnerability(`client, `Website, AccessDataWithSASToken)"}, 
"outcome": {"2": null, "3": null}, 
"reward": {"2": 0.0, "3": 0.0}, 
"reward_info": {"2": null, "3": null}, 
"manual": {"2": "agent", "3": "agent"}}
```



### Get History

Returns the history of attacks.

```
GET /demo/episodes/{{episode_id}}/history/ HTTP/1.1
```

Like response in the 'Run Attack' API, response is is generated by the 'pandas.DataFrame.to_json' function:

**Example response:**

```
{"iteration":{"0":1,"1":2,"2":3,"3":4},
"attack":{"0":"local_vulnerability(`client, SearchEdgeHistory)","1":"remote_vulnerability(`client, `client, CredScanGitHistory)","2":"remote_vulnerability(`client, `Website, ScanSharepointParentDirectory)","3":"remote_vulnerability(`client, `Website, AccessDataWithSASToken)"},
"outcome":{"0":"LeakedNodesId","1":null,"2":null,"3":null},
"reward":{"0":11.0,"1":0.0,"2":0.0,"3":0.0},
"reward_info":{"0":"Web browser history revealed website URL of interest","1":null,"2":null,"3":null},
"manual":{"0":"manual","1":"agent","2":"agent","3":"agent"}}
```



### Get Attack Path

Returns an attack path generated by the agent.

```
GET /demo/episodes/{{episode_id}}/attackpath/ HTTP/1.1
```

It takes some time the first time call the api for the agent to generate an attack path.

Like response in the 'Run Attack' API, response is is generated by the 'pandas.DataFrame.to_json' function:

**Turn into a dataframe:**

|      | iteration |                                            attack |           outcome | reward |                                       reward_info | manual |
| ---: | --------: | ------------------------------------------------: | ----------------: | -----: | ------------------------------------------------: | ------ |
|   12 |         1 |   local_vulnerability(`client, SearchEdgeHistory) |     LeakedNodesId |   11.0 | Web browser history revealed website URL of in... | agent  |
|   20 |         2 | remote_vulnerability(`client, `Website, ScanPa... |     LeakedNodesId |   11.0 | WEBSITE page content has a link to github -> G... | agent  |
|   25 |         3 | remote_vulnerability(`client, `Website, ScanPa... |     LeakedNodesId |   11.0 | Viewing the web page source reveals a URL to a... | agent  |
|  131 |         4 | remote_vulnerability(`client, `Website.Directo... |     LeakedNodesId |   11.0 | Navigating to parent URL revealed file `deprec... | agent  |
|  148 |         5 | remote_vulnerability(`client, `Website.Directo... | LeakedCredentials |    9.0 | Discover browseable web directory: Navigating ... | agent  |
|  177 |         6 | connect(`client, `Website, SSH, ReusedMySqlCre... |       LateralMove |  100.0 |     FLAG: Login using insecure SSH user\/password | agent  |
|  227 |         7 | remote_vulnerability(`Website, `Sharepoint, Sc... | LeakedCredentials |   14.0 |  Navigating to the Sharepoint site revealed AD... | agent  |
|  259 |         8 | connect(`client, `AzureResourceManager, HTTPS,... |       LateralMove |   50.0 | FLAG: Shared credentials with database user - ... | agent  |
|  271 |         9 | remote_vulnerability(`AzureResourceManager, `G... | LeakedCredentials |   14.0 | CredScan success: Some secure access token (SA... | agent  |
|  276 |        10 | connect(`client, `AzureStorage, HTTPS, SASTOKEN1) |       LateralMove |   50.0 |                                                   | agent  |
|  923 |        11 | remote_vulnerability(`client, `AzureResourceMa... |     LeakedNodesId |   11.0 |       Obtained Azure VM and public IP information | agent  |
| 1772 |        12 | remote_vulnerability(`AzureResourceManager, `A... |      CustomerData |    6.0 |      Stole data using a publicly shared SAS token | agent  |
| 2580 |        13 | local_vulnerability(`Website, CredScanBashHist... | LeakedCredentials |   14.0 | FLAG: SSH history revealed credentials for the... | agent  |
| 2581 |        14 | connect(`Website, `Website[user=monitor], su, ... |       LateralMove |  100.0 | FLAG User escalation by stealing credentials f... | agent  |
| 2616 |        15 | local_vulnerability(`Website[user=monitor], Cr... | LeakedCredentials |   14.0 | SSH: cat ~\/azurecreds.txt (running as monitor... | agent  |
| 3996 |        16 | connect(`AzureStorage, `AzureResourceManager[u... |       LateralMove | 5000.0 | More secrets stolen when logged as interactive... | agent  |

